# DDS 训练异常的根因说明

## 问题现象
- 训练 50 epoch 后，loss 下降但 `val_mAP@0.5` 和 `meanIoU` 近乎为 0，预测框在图 1/2/3 呈现“乱标注”。

## 直接原因（标注被静默丢弃）
- DDS 标注文件中实际存在 **6 个类别 id（0–5）**。例如 `Augmented_Data/train/labels/100_jpg.rf.0de758cbda471ed8e47e8c336796094c.txt` 的第一行就是类别 `5` 的框。
- 但旧版 `config.py` 将 `NUM_CLASSES` 设为 3，并在 `parse_yolo_annotation` 中对 `cls_idx >= NUM_CLASSES` 的框直接 `continue`，导致 **id ≥3 的框全部被跳过**。
- 这样一来，数据集中大部分目标在训练/验证时都不存在：
  - 训练损失仍能下降（模型只在少量“合法”框上收敛），
  - 但验证计算 mAP/IoU 时几乎找不到匹配框，于是指标接近 0，视觉上也表现为乱框。

## 现有修复
- 将默认类别数改为 6，并提供与 id 对应的占位名称，避免默认配置再次截断标签。【F:config.py†L47-L58】
- 解析标注时改为 **显式报错**（而不是静默跳过）当遇到超出 `NUM_CLASSES` 的 id，第一时间暴露配置-数据不匹配问题。【F:datasets/dental_dds.py†L20-L34】
- 在 README 中提示 DDS 默认含 6 类，使用前应确认并同步配置，避免误配。【F:README.md†L31-L35】

## 建议排查/使用方式
1. 如果你替换了自定义数据或精简了类别，务必同步修改 `NUM_CLASSES` 和 `CLASS_NAMES`，并确认标注文件里的最大 id 没有超出范围。
2. 运行一个快速 sanity check（例如读取几份标签并统计最大类 id），确认不会触发解析时的越界报错。
3. 若仍有 mAP 异常，继续检查 anchors、输入尺寸、以及评估时的置信度阈值，但首先确保“标签未被丢弃”这一根因已解决。

## v2 debug
- **现象复盘**：在类别数修正后，val mAP 依然约为 0、mean IoU ≈ 0.005，验证可视化中红框（预测）与绿框（GT）严重错位。
- **红框/绿框含义**：评估可视化里，绿色框是标注真值，红色框是模型预测结果（含置信度和类别文字）。
- **新发现的根因**：评估阶段在 `Evaluator.compute` 中错误地把**已为 xyxy 的预测框再次按 cxcywh 解读并转换**，导致 IoU 计算几乎为 0，所有匹配被判为负样本，从而 mAP/IoU 继续塌陷。【F:utils/metrics.py†L39-L84】【F:utils/metrics.py†L72-L78】
- **修复办法**：移除对预测框的错误二次转换，仅对 GT 做 cxcywh→xyxy，再用同一坐标系计算 IoU；验证重跑后指标才会反映模型真实水平。【F:utils/metrics.py†L72-L78】

## v3 debug
- **最新现象**：修复坐标系后，50 epoch 训练输出 `val_mAP@0.5≈0.20`、`meanIoU≈0.005`，可视化里红框数量远多于绿框且大多不重合。
- **问题定位**：验证阶段的置信度阈值仍设为 `0.05`，会把大量极低置信度的候选框也纳入 NMS 与评估；这些弱候选既拉低 mAP 精度，也在 mean IoU 计算中被计入，导致平均 IoU 被“海量低质量框”稀释到接近 0，视觉上表现为满屏红框。
- **处理措施**：
  - 将验证阈值提高到与推理一致的 `0.25`，过滤掉大部分无意义的低置信度框，减少红框噪声。【F:config.py†L63-L68】
  - 在解码阶段加入按分数排序的 `MAX_DETECTIONS` 限制（50），即便模型产出过多候选也只保留高分框，避免指标与可视化被低质量框主导。【F:models/yolotiny.py†L51-L67】
- **后续建议**：使用新的阈值和截断策略重新验证/可视化；如需更激进过滤，可进一步提高阈值或调小 `MAX_DETECTIONS`，但首要目标是屏蔽低置信度噪声以观测模型真实定位质量。

## v4 debug
- **最新现象**：更高阈值后，`val_mAP@0.5≈0.16`、`meanIoU≈0.024`，红框依然明显多于绿框且重合度不足，表明模型仍在产出大量与 GT 不匹配的候选。
- **问题根因**：
  - 主干网络最终特征图下采样 1/32，配合只有一组方形 anchor（32/64/128），对 DDS 中**细长且高度主导的牙齿框（宽度四分位数 ~37–56px，高度四分位数 ~105–150px，长宽比中位 2.8）**分辨率过粗且形状不匹配。网格粒度过大 → 中心/尺寸回归量化误差大，方形 anchor 难以覆盖纵向目标，导致预测框大量偏移/变形，与 GT 几乎不重合，mAP 和 IoU 双双受损，视觉上表现为“满屏红框但命中少”。
- **修复措施**：
  - 将网络最终 stride 从 32 收敛到 **16**，把输出特征图从 20×20 提升到 40×40，显著细化定位粒度，减少因网格过粗造成的中心偏移。【F:config.py†L36-L38】【F:models/backbone.py†L17-L28】
  - 将 anchor 更新为**纵向长条形** `(40×110, 56×140, 72×180)` 以贴合真实框的尺寸分布，降低回归偏差。【F:config.py†L26-L33】
  - 进一步收紧验证/推理置信度阈值到 0.35 并将解码最大保留框数降至 30，避免长尾低分框继续充斥评估和可视化，使指标更聚焦于高质量候选。【F:config.py†L64-L67】
- **后续验证建议**：用上述配置重新训练或从现有权重继续 fine-tune；关注 IoU 是否提升（粒度和 anchor 适配应优先改善定位），若仍有漏检可再微调阈值或增加多尺度/额外检测层，但先用 stride16 + 长条 anchor 验证改动效果。
