# DDS 训练异常的根因说明

## 问题现象
- 训练 50 epoch 后，loss 下降但 `val_mAP@0.5` 和 `meanIoU` 近乎为 0，预测框在图 1/2/3 呈现“乱标注”。

## 直接原因（标注被静默丢弃）
- DDS 标注文件中实际存在 **6 个类别 id（0–5）**。例如 `Augmented_Data/train/labels/100_jpg.rf.0de758cbda471ed8e47e8c336796094c.txt` 的第一行就是类别 `5` 的框。
- 但旧版 `config.py` 将 `NUM_CLASSES` 设为 3，并在 `parse_yolo_annotation` 中对 `cls_idx >= NUM_CLASSES` 的框直接 `continue`，导致 **id ≥3 的框全部被跳过**。
- 这样一来，数据集中大部分目标在训练/验证时都不存在：
  - 训练损失仍能下降（模型只在少量“合法”框上收敛），
  - 但验证计算 mAP/IoU 时几乎找不到匹配框，于是指标接近 0，视觉上也表现为乱框。

## 现有修复
- 将默认类别数改为 6，并提供与 id 对应的占位名称，避免默认配置再次截断标签。【F:config.py†L47-L58】
- 解析标注时改为 **显式报错**（而不是静默跳过）当遇到超出 `NUM_CLASSES` 的 id，第一时间暴露配置-数据不匹配问题。【F:datasets/dental_dds.py†L20-L34】
- 在 README 中提示 DDS 默认含 6 类，使用前应确认并同步配置，避免误配。【F:README.md†L31-L35】

## 建议排查/使用方式
1. 如果你替换了自定义数据或精简了类别，务必同步修改 `NUM_CLASSES` 和 `CLASS_NAMES`，并确认标注文件里的最大 id 没有超出范围。
2. 运行一个快速 sanity check（例如读取几份标签并统计最大类 id），确认不会触发解析时的越界报错。
3. 若仍有 mAP 异常，继续检查 anchors、输入尺寸、以及评估时的置信度阈值，但首先确保“标签未被丢弃”这一根因已解决。

## v2 debug
- **现象复盘**：在类别数修正后，val mAP 依然约为 0、mean IoU ≈ 0.005，验证可视化中红框（预测）与绿框（GT）严重错位。
- **红框/绿框含义**：评估可视化里，绿色框是标注真值，红色框是模型预测结果（含置信度和类别文字）。
- **新发现的根因**：评估阶段在 `Evaluator.compute` 中错误地把**已为 xyxy 的预测框再次按 cxcywh 解读并转换**，导致 IoU 计算几乎为 0，所有匹配被判为负样本，从而 mAP/IoU 继续塌陷。【F:utils/metrics.py†L39-L84】【F:utils/metrics.py†L72-L78】
- **修复办法**：移除对预测框的错误二次转换，仅对 GT 做 cxcywh→xyxy，再用同一坐标系计算 IoU；验证重跑后指标才会反映模型真实水平。【F:utils/metrics.py†L72-L78】

## v3 debug
- **最新现象**：修复坐标系后，50 epoch 训练输出 `val_mAP@0.5≈0.20`、`meanIoU≈0.005`，可视化里红框数量远多于绿框且大多不重合。
- **问题定位**：验证阶段的置信度阈值仍设为 `0.05`，会把大量极低置信度的候选框也纳入 NMS 与评估；这些弱候选既拉低 mAP 精度，也在 mean IoU 计算中被计入，导致平均 IoU 被“海量低质量框”稀释到接近 0，视觉上表现为满屏红框。
- **处理措施**：
  - 将验证阈值提高到与推理一致的 `0.25`，过滤掉大部分无意义的低置信度框，减少红框噪声。【F:config.py†L63-L68】
  - 在解码阶段加入按分数排序的 `MAX_DETECTIONS` 限制（50），即便模型产出过多候选也只保留高分框，避免指标与可视化被低质量框主导。【F:models/yolotiny.py†L51-L67】
- **后续建议**：使用新的阈值和截断策略重新验证/可视化；如需更激进过滤，可进一步提高阈值或调小 `MAX_DETECTIONS`，但首要目标是屏蔽低置信度噪声以观测模型真实定位质量。

## v4 debug
- **最新现象**：更高阈值后，`val_mAP@0.5≈0.16`、`meanIoU≈0.024`，红框依然明显多于绿框且重合度不足，表明模型仍在产出大量与 GT 不匹配的候选。
- **问题根因**：
  - 主干网络最终特征图下采样 1/32，配合只有一组方形 anchor（32/64/128），对 DDS 中**细长且高度主导的牙齿框（宽度四分位数 ~37–56px，高度四分位数 ~105–150px，长宽比中位 2.8）**分辨率过粗且形状不匹配。网格粒度过大 → 中心/尺寸回归量化误差大，方形 anchor 难以覆盖纵向目标，导致预测框大量偏移/变形，与 GT 几乎不重合，mAP 和 IoU 双双受损，视觉上表现为“满屏红框但命中少”。
- **修复措施**：
  - 将网络最终 stride 从 32 收敛到 **16**，把输出特征图从 20×20 提升到 40×40，显著细化定位粒度，减少因网格过粗造成的中心偏移。【F:config.py†L36-L38】【F:models/backbone.py†L17-L28】
  - 将 anchor 更新为**纵向长条形** `(40×110, 56×140, 72×180)` 以贴合真实框的尺寸分布，降低回归偏差。【F:config.py†L26-L33】
  - 进一步收紧验证/推理置信度阈值到 0.35 并将解码最大保留框数降至 30，避免长尾低分框继续充斥评估和可视化，使指标更聚焦于高质量候选。【F:config.py†L64-L67】
- **后续验证建议**：用上述配置重新训练或从现有权重继续 fine-tune；关注 IoU 是否提升（粒度和 anchor 适配应优先改善定位），若仍有漏检可再微调阈值或增加多尺度/额外检测层，但先用 stride16 + 长条 anchor 验证改动效果。

## v5 debug
- **现象复盘**：
  - 第 9 epoch 出现 `meanIoU≈0.64` 但 `mAP≈0.00` 的异常组合，表面上似乎“框和 GT 重合度很高”，但分类几乎全错。
  - 训练到 50 epoch 后仍停留在 `mAP≈0.04` / `IoU≈0.12`，可视化里红框数量依旧明显多于绿框且重叠有限，说明分类与抑制仍未稳定。
- **原因排查**：
  1. **类别极度不平衡 → 框定位对但类别错**：训练集中类别分布极斜（class5=3293、class0=853、class3=69）。未加权的 BCE 会让主频类主导分类头，导致模型把多类牙齿都判为高频类。出现“框位置对但类别错”时 IoU 按位置算会很高，但 mAP 按类别算会接近 0，对应中途的异常指标。【F:datasets/dental_dds.py†L14-L31】【F:train.py†L41-L52】
  2. **跨类别 NMS 导致“错抑制 + 冗余”**：解码阶段用全局 NMS，跨类别的重叠框会互相抑制，残留的次高分框又以另一类别输出，既引入大量红框，也进一步拉低分类精度。【F:models/yolotiny.py†L46-L90】
  3. **初始偏置过高，早期就产生海量低质框**：`pred` 卷积的 objectness/class 偏置默认为 0，训练早期会输出大量 0.5 左右的置信度，负样本损失占据主导，难以收敛到稳态，红框数量长期偏多。【F:models/head.py†L16-L28】
- **修复与改进（已实施）**：
  - **加入类别加权 BCE**：按训练标签频次动态计算 class weight，并在分类损失中归一化使用，提升长尾类梯度占比，降低“框对但类错”带来的低 mAP。【F:datasets/dental_dds.py†L14-L31】【F:losses/detection_loss.py†L11-L33】【F:train.py†L41-L52】
  - **改为每类独立 NMS + 全局 Top-K**：先按类别做 NMS 再整体按分数截断，避免跨类错抑制并减少重复红框，让评估/可视化更接近真实分类结果。【F:models/yolotiny.py†L46-L90】
  - **下调预测头偏置**：在检测头初始化时将 objectness 与类别偏置设为 -4，抑制训练初期的低质高分框，配合阈值/Top-K 策略降低红框噪声。【F:models/head.py†L16-L28】
- **对“中途高 IoU 低 mAP”现象的判断**：
  - 该现象源于分类失衡导致的伪好转：定位可对齐 GT，所以 IoU 能短暂飙高；但分类几乎全错，mAP/召回趋近 0，因此不可视为真实提升。
  - 观察验证曲线时应同时看 PR / confusion matrix，而非单看 IoU，避免被“框对类错”的假信号误导训练决策。
- **后续优化建议**：
  1. 用当前改动重新训练或接着 fine-tune，关注 mAP 是否随分类稳定而回升；若 GPU 允许可延长训练到 150 epoch 让加权分类头充分收敛。
  2. 若仍有大量红框，可适度提高 `CONF_THRESHOLD`（如 0.45）或进一步调低 `MAX_DETECTIONS`，在可视化/验证时增强过滤，同时观察长尾类的召回不要过度下降。
 3. 若想进一步提升长尾表现，可在当前权重基础上加入 focal loss 或增设额外检测层；但建议先用“加权 BCE + 类内 NMS”重新评估，确认主要分类/抑制问题已收敛后再做更大改动。

## v6 debug
- **最新现象**：50 epoch 后 `mAP@0.5≈0.05`、`meanIoU≈0.15`，可视化中红框数量仍多且与 GT 重叠度普遍偏低，提示评估阶段仍存在系统性偏差。
- **新定位的根因**：训练/验证时对长条全景片直接拉伸到 `640×640`，但 GT 框依然使用**原图坐标的归一化数值**。模型预测在拉伸后坐标系下计算，评估却用未拉伸的 GT → 预测与 GT 落在不同坐标系，IoU 被系统性压低，表现为“红框多、指标低”。
- **修复措施**：
  - 为 DDS 引入 letterbox 预处理：按最长边等比例缩放后四周填充到正方形，保持纵横比不变，并用同样的缩放/填充值同步变换 GT 框，统一坐标系。【F:datasets/dental_dds.py†L18-L26】【F:datasets/dental_dds.py†L125-L168】
  - 移除强制拉伸的 `Resize`，保持图像几何不被扭曲，使 anchor/stride 与实际牙齿形态匹配，减少不必要的回归偏差。【F:datasets/dental_dds.py†L52-L59】
- **改进预期**：对齐预测与 GT 坐标系后，IoU 计算将反映真实定位质量，mAP 不再被“坐标错位”拖垮；结合此前的类内 NMS 和长条 anchor，红框数量应显著收敛，指标回归到模型真实水平。

## v7 debug
- **最新现象**：引入 letterbox 后，输出图像尺寸改变（左右/上下留灰边），但预测红框仍大面积偏离绿色 GT 框，mAP/IoU 仍低。
- **定位出的剩余问题**：
  - 推理/评估阶段的框坐标仍停留在**填充后的 640×640 坐标系**，在对比/绘制到原始全景片时没有撤销填充与缩放，导致红框在原图上偏移（尤其在长条形图像的左右灰边区域），评价指标也在错误坐标系下计算。
- **修复措施**：
  1. 数据集返回 letterbox 的缩放比例与四边填充值，并保留原图尺寸及原始 GT，方便统一反变换。【F:datasets/dental_dds.py†L70-L116】
  2. 新增 `unletterbox_boxes`，在评估和可视化前将预测框从 640×640 填充坐标系映射回原图绝对坐标；GT 也回到原图像素空间后再计算 IoU/mAP，避免坐标系错位带来的假低分。【F:datasets/dental_dds.py†L118-L137】【F:utils/metrics.py†L11-L63】
  3. `eval.py`/`infer_visualize.py` 改为在原图上绘制绿框/红框，确保肉眼对齐效果与指标一致，不再受灰边干扰。【F:eval.py†L41-L63】【F:infer_visualize.py†L44-L74】
- **后续建议**：
  - 用修复后的坐标系重新跑验证/可视化，确认红框与绿框重合度的真实情况。如果 mAP/IoU 仍低，则表明模型表达能力或训练轮次仍不足，可在坐标系正确的前提下再考虑多尺度训练、翻转等数据增强或延长训练轮次。

## v8 debug
- **最新现象**：坐标系修复后，指标仍徘徊在 `mAP@0.5≈0.12`、`meanIoU≈0.03`，可视化里依旧出现大量与 GT 不重叠的红框。
- **新增根因**：数据标注存在**非法框（超界或宽高为 0）**，在训练/评估时被当作有效目标加入损失与匹配，导致回归损失被错误监督拉偏、NMS 里混入畸形候选，从而输出更多高偏移的红框，拖低 mAP/IoU。
- **修复措施**：
  - 为标注解析新增严格校验：中心/宽高必须在 (0,1] 且类别 id 合法，否则将该框丢弃并打印 warning，防止坏标签进入训练/评估。【F:datasets/dental_dds.py†L20-L69】
- **下一步验证**：
  1. 用 v8 过滤后重新训练或在最新权重上继续 fine-tune，观察红框数量是否减少、mAP/IoU 是否抬升；日志中若出现 warning，需回溯对应图片并在标注层面修正。
  2. 若仍有异常，可在数据层面统计并人工检查被丢弃的文件，确认是否存在系统性标注偏移或成批错误标注。

## v9 debug
- **暴露的新问题**：命令行评估入口 `eval.py` 缺少 `argparse` 与 `Path` 的导入，直接运行会在解析参数前抛出 `NameError`，导致最新版的评估/可视化压根无法跑通，前面几轮的“验证”实际上没有真正覆盖最新模型与修复。
- **影响**：无法生成新的 mAP/IoU 与红/绿框对比图，容易误以为代码层面仍有模型质量问题，实则评估链路中断。
- **修复措施**：补全必要的标准库导入，确保 `python eval.py --checkpoint ...` 能正常运行并产出最新指标与可视化。【F:eval.py†L1-L19】

## v10 debug
- **澄清**：本轮修复只恢复了评估/可视化链路，不会直接改善训练过程的 mAP/IoU。训练质量要靠重新跑一遍验证或可视化对比（`eval.py` / `infer_visualize.py`），确认模型在最新代码下的真实表现。
- **建议**：先用修复后的 `eval.py` 跑一次验证，拿到可比的 mAP/IoU 与红/绿框对齐图，再决定是否需要进一步改动模型或数据。

## v11 debug
- **残留问题**：`build_yolo_target` 对同一网格单元只保留“最后写入”的目标，若两颗牙中心落在同一 cell（DDS 全景片常见），后写的框会覆盖前一个，导致大量 GT 在训练中被静默丢弃 → 模型召回难以提升，mAP/IoU 长期偏低。
- **修复措施**：为每个 cell 跟踪已占用的 anchor，按框-Anchor IoU 从高到低选择“首个空闲 anchor”，避免无声覆盖；若 cell 已被 3 个 anchor 占满才回退到最高 IoU anchor。中心落在边界时还会 clamp 到合法网格索引，防止越界。【F:datasets/dental_dds.py†L158-L202】
- **预期影响**：同一网格内的多颗牙都能生成监督信号，减少正样本丢失，提升召回与分类的可学习性；再次训练/验证时 mAP 与 IoU 应随更完整的监督而回升。

